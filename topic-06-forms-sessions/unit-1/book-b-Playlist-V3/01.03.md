## Song hinzufügen

### 1. Neuer View

Neue Songs sollen über die Eingabe der Informationen in einem Formular erstellt werden.
Dazu ist es am sinnvoll, ein neues partial zu erstellen, dass danach in andere Views eingebunden werden kann.

Erstellen Sie im Ordner `views/partials` eine neue Datei `addsong.hbs` und ergänzen darin folgenden Code:
~~~ html
<form action="/playlist/{{playlist.id}}/addsong" method="POST">
    <div class="row">
        <div class="mb-3 col-4">
            <label htmlFor="inputTitle" className="form-label">Title</label>
            <input placeholder="Title" type="text" className="form-control" id="inputTitle" name="title">
        </div>
        <div class="mb-3 col-4">
            <label htmlFor="inputArtist" className="form-label">Artist</label>
            <input placeholder="Artist" type="text" className="form-control" id="inputArtist" name="artist">
        </div>
        <div class="mb-3 col-4">
            <label htmlFor="inputDuration" className="form-label">Duration</label>
            <input placeholder="00" type="number" className="form-control" id="inputDuration" name="duration">
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Add Song</button>
</form>
~~~

Das neu erstellte Partial soll nun innerhalb des `playlist` views eingegliedert werden. Passen Sie dazu die `playlist.hbs` Datei
wie folgt an:

~~~ hbs 
{{> menu}}

<section class="ui center aligned middle aligned segment">
  <h2 class="ui header">
    {{playlist.title}}
  </h2>
  {{> listsongs}}
  {{> addsong}}
</section>
~~~

Mit der Einbindung des Formulares sollte die Seite nun wie folgt aussehen:
![img_2.png](img/img_2.png)

### 2. Neuer Router

Das oben erstellte Formular versucht den neuen Song an die Route `/playlist/{{playlist.id}}/addsong` zu senden. Diese ist zum aktuellen Status allerdings noch nicht implementiert, sodass das Formular keinerlei Funktion hat.

Erstellen Sie, um dies zu ändern, einen neuen Router, der auf unseren Playlist Controller zurückgreift. Darin werden wir gleich auch eine neue Funktion `addSong` ergänzen.

Ergänzen Sie in der `routes.js` folgende Zeile:
~~~ js
...
router.post('/playlist/:id/addsong', playlist.addSong);
...
~~~
### 3. Controller anpassen
Und darauf die Funktion `addSong` in unserem Controller `playlist.js`.

~~~ js
    async addSong(request, response) {
        const playlistId = request.params.id;
        const newSong = {
            title: request.body.title,
            artist: request.body.artist,
            duration: Number(request.body.duration)
        };
        logger.debug("New Song", newSong);
        await songStore.addSong(playlistId, newSong);
        response.redirect("/playlist/" + playlistId);
    },
...
~~~

### 4. Model Funktion hinzufügen

Der soeben implementierte Controller ruft die `addSong` Methode des `song-store` Models.
Diese Funktion muss nun ergänzt werden. Passen Sie dazu die Datei `song-store.js` wie folgt an, damit Songs in der Datenbank hinzugefügt werden können.
~~~ js
const dataStore = require("./data-store.js");
const dataStoreClient = dataStore.getDataStore();
const logger = require("../utils/logger.js");

const songStore = {
    async getSongsForPlayList(playListId) {
        const query = 'SELECT * FROM playlist_songs WHERE playlist_id=$1';
        const values = [playListId];
        try {
            let result = await dataStoreClient.query(query, values);
            return result.rows;
        } catch (e) {
            logger.error("Error fetching songs for playlist" ,e);
        }
    },
    async removeSong(songId) {
        const query = 'DELETE FROM playlist_songs WHERE id=$1';
        const values = [songId];
        try {
            await dataStoreClient.query(query, values);
        } catch (e) {
            logger.error("Unable to remove song from playlist", e);
        };
    },
    async addSong(playlistId, newSong) {
        const query = 'INSERT INTO playlist_songs (TITLE, ARTIST, DURATION, PLAYLIST_ID) VALUES($1, $2, $3, $4)';
        const values = [newSong.title, newSong.artist, newSong.duration, playlistId];
        try {
            await dataStoreClient.query(query, values);
        } catch (e) {
            logger.error("Error adding song", e);
        }
    },
};

module.exports = songStore;

~~~

